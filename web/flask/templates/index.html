{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block content %}



<div id="dashboard-wrapper">
	<div id="dashboard-sidebar">
		<div id="dashboard-sidebar-logo">
			<i id="dashboard-sidebar-logo-icon" class="fa fa-book"></i>
			<div id="dashboard-sidebar-logo-text">Notebook<br>Generator</div>
		</div>
		<div id="dashboard-sidebar-user">
			<i id="dashboard-sidebar-user-icon" class="fa fa-user-circle-o"></i>
			<div id="dashboard-sidebar-user-info">
				<div id="dashboard-sidebar-user-name">Guest User</div>
				<div id="dashboard-sidebar-user-status"><i id="dashboard-sidebar-user-status-circle" class="fa fa-circle"></i>ONLINE</div>
			</div>
		</div>
		<ul id="dashboard-sidebar-options" class="nav nav-tabs" role="tablist">
			<li class="nav-item dashboard-sidebar-option">
				<a class="dashboard-sidebar-option-link nav-link active" data-toggle="tab" href="#home" role="tab" aria-controls="dashboard" aria-selected="true"><i class="fa fa-tachometer"></i>Dashboard</a>
			</li>
			<li class="nav-item dashboard-sidebar-option">
				<a class="dashboard-sidebar-option-link nav-link" data-toggle="tab" href="#notebooks" role="tab" aria-controls="notebooks" aria-selected="false"><i class="fa fa-book"></i>Notebooks</a>
			</li>
			<li class="nav-item dashboard-sidebar-option">
				<a class="dashboard-sidebar-option-link nav-link" data-toggle="tab" href="#datasets" role="tab" aria-controls="datasets" aria-selected="false"><i class="fa fa-table"></i>Datasets</a>
			</li>
			<li class="nav-item dashboard-sidebar-option">
				<a class="dashboard-sidebar-option-link nav-link" data-toggle="tab" href="#tools" role="tab" aria-controls="tools" aria-selected="false"><i class="fa fa-cogs"></i>Tools</a>
			</li>
			<li class="nav-item dashboard-sidebar-option">
				<a class="dashboard-sidebar-option-link nav-link" data-toggle="tab" href="#help" role="tab" aria-controls="help" aria-selected="false"><i class="fa fa-question-circle"></i>Help</a>
			</li>
			<li class="nav-item dashboard-sidebar-option">
				<a class="dashboard-sidebar-option-link nav-link" data-toggle="tab" href="#generate" role="tab" aria-controls="help" aria-selected="false" style="display: none;"><i class="fa fa-file-text-o"></i>New Notebook</a>
			</li>
		</ul>
	</div>
	<div id="dashboard-main">
		<div id="dashboard-topbar">
			<form id="dashboard-topbar-search-form">
				<i id="dashboard-topbar-search-form-icon" class="fa fa-search"></i>
				<input id="dashboard-topbar-search-form-input" type="text" name="q" placeholder="Search...">
			</form>
		</div>

		<div id="dashboard-content" class="tab-content fill">
			<div class="tab-pane show active padded-lg" id="home" role="tabpanel">
				<div class="container-fluid">
					<div class="row">
						<div class="col-xl-7">
							<div class="row margin-bottom-sm">
								<div class="col-12">
									<div class="dashboard-title">Jupyter Notebook Generator</div>
								</div>
							</div>
							<div class="row margin-bottom-sm">
								<div class="col-9">
									<div class="dashboard-text">An intuitive user interface for the generation of Jupyter Notebooks containing bioinformatics analyses biomedical datasets.</div>
								</div>
								<div class="col-3">
									<button id="get-started-button" class="btn btn-primary new-notebook-button">Get Started <i class="fa fa-angle-double-right"></i></button>
								</div>
							</div>
							<div class="row margin-bottom-sm">
								<div class="col-12">
									<div id="{{ id }}-card" class="dashboard-card">
										<div class="dashboard-card-title">HOW IT WORKS</div>
										<div class="dashboard-card-contents">
											<div class="row">
												{{ macros.step(icon='database', number=1, title='Add Data', description='Choose from over 5,000 preprocessed datasets, or upload your own', line_right=True) }}
												{{ macros.step(icon='cog', number=2, title='Add Tools', description='Use dozens of pre-configured analysis scripts, or provide your own code', line_left=True, line_right=True) }}
												{{ macros.step(icon='book', number=3, title='Launch!', description='Explore, download and share analysis results from your Notebook Server', line_left=True) }}
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="row margin-bottom-sm">
								<div class="col-12">
									<div id="examples-title" class="dashboard-title">Examples</div>
								</div>
							</div>
							<div class="row margin-bottom-md">
								<div class="col-12">
									<div class="dashboard-text">Explore Jupyter Notebook generated using the Notebook Generator.</div>
								</div>
							</div>
							<div class="row">
								{% for notebook in range(3) %}
									{{ macros.notebook(title='Analysis Notebook '+(notebook+1)|string, colsize='col-4', example=True) }}
								{% endfor %}
							</div>
						</div>
						<div class="col-xl-5">
							<div class="row">
								<div class="col-11 offset-1">
									<div class="row margin-bottom-sm">
										<div class="col-12">
											<div class="dashboard-title">Overview</div>
										</div>
									</div>
									<div class="row margin-bottom-md">
										{{ macros.badge(title='3/15 Notebooks', description='', color='#006B99', icon='book', id='notebook', button='+', progress=0.2) }}
									</div>
									<div class="row margin-bottom-md">
										{{ macros.badge(title='1/3 Datasets', description='', color='#006B99', icon='table', id='dataset', button='+', progress=0.33) }}
									</div>
									<div class="row margin-bottom-sm">
										<div class="col-12">
											<div class="dashboard-title">Components</div>
										</div>
									</div>
									<div class="row margin-bottom-md">
										{{ macros.badge(title='5,000+ Datasets', description='', color='#FF4463', icon='database', id='notebook', search=True) }}
									</div>
									<div class="row margin-bottom-md">
										{{ macros.badge(title='20+ Tools', description='', color='#A65F9D', icon='cogs', id='notebook', search=True) }}
									</div>
									<div class="row margin-bottom-md">
										{{ macros.badge(title='5 Toolkits', description='', color='#FE973C', icon='wrench', id='notebook', search=True) }}
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="tab-pane fill" id="notebooks" role="tabpanel">
				<div class="container-fluid fill">
					<div id="stored-notebooks" class="padded-lg">
						<div class="row">
							<div class="col-12">
								<div class="dashboard-title margin-bottom-md">Notebooks</div>
							</div>
						</div>
						<div id="notebook-row" class="row">
							{% for notebook in notebooks %}
								{{ macros.notebook(title=notebook['notebook_uid'], notebook_uid=notebook['notebook_uid'], notebook_name=notebook['notebook_name'].replace('.ipynb', '')) }}
							{% endfor %}
						</div>
					</div>
					<div id="new-notebook" class="fill">
						<div id="new-notebook-header-row" class="row padded-lg">
							<div class="col-6">
								<div class="dashboard-title-lg">Create a New Notebook</div>
							</div>
							<div class="col-6 text-right">
								<button id="new-notebook-cancel-button" class="btn btn-secondary new-notebook-navigation-button">Cancel</button>
								<button id="new-notebook-back-button" class="btn btn-primary new-notebook-navigation-button"><i class="fa fa-angle-double-left"></i> Back</button>
								<button id="new-notebook-continue-button" class="btn btn-primary new-notebook-navigation-button">Continue <i class="fa fa-angle-double-right"></i></button>
								<button id="new-notebook-generate-button" class="btn btn-success new-notebook-navigation-button generate-notebook-button">Generate!</button>
							</div>
						</div>
						<div id="new-notebook-content-row" class="row">
							<div id="new-notebook-content" class="col-9 padded-lg">
								<div id="new-notebook-add-data" class="notebook-step-contents notebook-step-contents-active">
									<div class="row">
										<div class="col-12">
											<div class="dashboard-title margin-bottom-sm">1. Add Data</div>
											<div class="dashboard-text margin-bottom-md">To begin, select a dataset from below, or add your own using the dataset upload form.</div>
										</div>
									</div>
									<div class="row">
										<div class="col-12">
											<div id="" class="tab-card">
												<ul class="nav nav-tabs nav-justified">
												  <li class="nav-item">
												    <a class="nav-link active" data-toggle="tab" href="#processed-data" role="tab" aria-controls="processed-data" aria-selected="true">Processed Data</a>
												  </li>
												  <li class="nav-item">
												    <a class="nav-link" data-toggle="tab" href="#uploaded-data" role="tab" aria-controls="uploaded-data" aria-selected="false">Uploaded Data</a>
												  </li>
												</ul>
												<div class="tab-card-content tab-content">
													<div class="tab-pane show active padded-lg" role="tabpanel" id="processed-data">
														<table id="processed-data-table" class="table table-striped table-bordered" cellspacing="0">
															<thead>
																<tr>
																	<th></th>
																	<th>Accession</th>
																	<th>Title</th>
																	<!-- <th>Description</th> -->
																	<th>Repository</th>
																</tr>
															</thead>
															<tbody>
																{% for index, rowData in datasets.head(100).iterrows() %}
																<tr>
																	<td></td>
																	<td>{{ rowData.dataset_accession }}</td>
																	<td class="processed-dataset-title">{{ rowData.title }}</td>
																	<!-- <td class="processed-dataset-description">{{ rowData.summary }}</td> -->
																	<td>GEO</td>
																</tr>
																{% endfor %}
															</tbody>
														</table>
													</div>
													<div class="tab-pane padded-lg" role="tabpanel" id="uploaded-data">
														<div class="under-development">Under development.</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div id="new-notebook-add-tools" class="notebook-step-contents">
									<div class="row">
										<div class="col-12">
											<div class="dashboard-title margin-bottom-sm">2. Add Tools</div>
											<div class="dashboard-text margin-bottom-md">Select one or more analysis tools, or one preset toolkit, from the menu below.</div>
										</div>
									</div>
									<div class="row">
										<div class="col-12">
											<div id="" class="tab-card">
												<ul class="nav nav-tabs nav-justified">
												  <li class="nav-item">
												    <a class="nav-link active" data-toggle="tab" href="#add-toolkit" role="tab" aria-controls="add-toolkit" aria-selected="true">Toolkits</a>
												  </li>
												  <li class="nav-item">
												    <a class="nav-link" data-toggle="tab" href="#add-tools" role="tab" aria-controls="add-tools" aria-selected="false">Tools</a>
												  </li>
												</ul>
												<div class="tab-card-content tab-content">
													<div class="tab-pane show active padded-lg" role="tabpanel" id="add-toolkit">
														<div class="row">
															{% for index, rowData in toolkits.head(3).iterrows() %}
															<input type="radio" name="toolkit-radio" id="toolkit-radio-{{ rowData['id'] }}" value="toolkit-radio-{{ rowData['id'] }}" class="toolkit-radio" {{ 'checked' if loop.index == 1 else '' }}>
															<label class="toolkit-radio-label col-4" for="toolkit-radio-{{ rowData['id'] }}">
																<div class="toolkit-card">
																	<div class="row fill">
																		<div class="col-5 my-auto">
																			<img class="toolkit-card-icon" src=" {{ url_for('static', filename='img/'+rowData['image']|string+'.png') }} ">
																		</div>
																		<div class="col-7 text-left">
																			<div class="toolkit-card-title">{{ rowData['name'] }}</div>
																			<div class="toolkit-card-description">{{ rowData['description'] }}</div>
																		</div>
																	</div>
																</div>
															</label>
															{% endfor %}
														</div>
													</div>
													<div class="tab-pane padded-lg" role="tabpanel" id="add-tools">
														<div class="under-development">Under development.</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div id="new-notebook-review" class="notebook-step-contents">
									<div class="row">
										<div class="col-12">
											<div class="dashboard-title margin-bottom-sm">3. Review</div>
											<div class="dashboard-text margin-bottom-md">Review the notebook configuration below..</div>
										</div>
									</div>
									<div class="row">
										<div class="col-12">
											<div class="under-development">You're all set.</div>
										</div>
									</div>
								</div>
								<div id="new-notebook-loading" class="notebook-step-contents">
									<div class="row">
										<div class="col-12">
											<div class="dashboard-title-lg text-center margin-top-xl margin-bottom-lg">Your Jupyter Notebook is Loading...</div>
										</div>
									</div>
									<div class="row">
										<div class="col-12">
											<div class="dashboard-text text-center">
												<div class="sk-cube-grid">
												 	<div class="sk-cube sk-cube1"></div>
												 	<div class="sk-cube sk-cube2"></div>
												 	<div class="sk-cube sk-cube3"></div>
												 	<div class="sk-cube sk-cube4"></div>
												 	<div class="sk-cube sk-cube5"></div>
												 	<div class="sk-cube sk-cube6"></div>
												 	<div class="sk-cube sk-cube7"></div>
												 	<div class="sk-cube sk-cube8"></div>
												 	<div class="sk-cube sk-cube9"></div>
												 </div>
											</div>
										</div>
									</div>
								</div>
								<div id="new-notebook-results" class="notebook-step-contents">
									<div class="row">
										<div class="col-12">
											<div class="dashboard-title-lg">Your Jupyter Notebook is Ready</div>
										</div>
									</div>
									<div class="row">
										<div class="col-12">
											<a id="new-notebook-link" class="under-development" href="#" target="_blank">Notebook Link</a>
										</div>
									</div>
								</div>
							</div>
							<div id="new-notebook-sidebar" class="col-3">
								<div id="new-notebook-data-row" class="row new-notebook-step active-notebook-step">
									<div class="col-12">
										1. Data
									</div>
								</div>
								<div id="new-notebook-selected-data" class="row padded-sm">
									<div class="col-12">
										{{ macros.selected_object(title='No Data Selected.', description='To proceed, select a dataset from the menu.', icon='table') }}
									</div>
								</div>
								<div id="new-notebook-tools-row" class="row new-notebook-step pending-notebook-step">
									<div class="col-12">
										2. Tools
									</div>
								</div>
								<div id="new-notebook-selected-tools" class="row padded-sm">
									<div class="col-12">
										{{ macros.selected_object(title='No Tools Selected', description='To proceed, select one or more tools from the menu.', icon='cogs') }}
									</div>
								</div>
								<div id="new-notebook-review-row" class="row new-notebook-step pending-notebook-step">
									<div class="col-12">
										3. Review
									</div>
								</div>
								<div id="new-notebook-continue-row" class="row">
									<div class="col-12">
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="tab-pane" id="datasets" role="tabpanel"><div class="under-development">This page is currently being developed.</div></div>
			<div class="tab-pane" id="tools" role="tabpanel"><div class="under-development">This page is currently being developed.</div></div>
			<div class="tab-pane" id="help" role="tabpanel"><div class="under-development">This page is currently being developed.</div></div>
		</div>
	</div>
</div>

{% endblock %}

{% block footer %}

<script type="text/javascript">
var table = $('#processed-data-table').DataTable(
	{
		pageLength: 5,
		lengthMenu: [[5, 10, 25], [5, 10, 25]],
		columnDefs:[
			{targets:0, orderable:false, order:[], className:'select-checkbox'},
			{targets:1},
			{targets:2, render:$.fn.dataTable.render.ellipsis(100, true)},
			{targets:3}
		],
		select: {
			style:'os',
			selector:'td:first-child'
		}
	}
);

// Selected Data
table
	.on('select', function(e, dt, type, indexes) {
		var rowData = table.rows( indexes ).data().toArray()[0];
		$('#new-notebook-selected-data .selected-object-card-title').html(rowData[1]);
		$('#new-notebook-selected-data .selected-object-card-description').html(rowData[2]);
	})
	.on('deselect', function(e, dt, type, indexes) {
		var rowData = table.rows( indexes ).data().toArray()[0];
		$('#new-notebook-selected-data .selected-object-card-title').html('No Data Selected.');
		$('#new-notebook-selected-data .selected-object-card-description').html('To proceed, select a dataset from the menu.');
	});

// Selected Toolkit
$('.toolkit-radio').change(function() {
	$('#new-notebook-selected-tools .selected-object-card-title').html($('.toolkit-radio:checked + .toolkit-radio-label .toolkit-card .toolkit-card-title').html());
	$('#new-notebook-selected-tools .selected-object-card-description').html($('.toolkit-radio:checked + .toolkit-radio-label .toolkit-card .toolkit-card-description').html());
})

// Toggle New Notebook
$('#new-notebook-cancel-button').click(function(){$('#new-notebook').hide();$('#stored-notebooks').show();})
$('.new-notebook-button').click(function(){$('a[href="#notebooks"]').tab('show');$('#stored-notebooks').hide();$('#new-notebook').show();})


// Form
var goAhead = function() {
	$('.active-notebook-step').siblings('.pending-notebook-step').first().removeClass('pending-notebook-step').addClass('active-notebook-step');
	$('.active-notebook-step').first().removeClass('active-notebook-step').addClass('completed-notebook-step');
	$('.notebook-step-contents-active').next().addClass('notebook-step-contents-active');
	$('.notebook-step-contents-active').first().removeClass('notebook-step-contents-active');
	$('#new-notebook-back-button').show();
};
var goBack = function() {
	if ($('.notebook-step-contents-active').attr('id') != 'new-notebook-loading') {
		$('.active-notebook-step').siblings('.completed-notebook-step').last().removeClass('completed-notebook-step').addClass('active-notebook-step');
		$('.active-notebook-step').last().removeClass('active-notebook-step').addClass('pending-notebook-step');
	}
	$('.notebook-step-contents-active').prev().addClass('notebook-step-contents-active');
	$('.notebook-step-contents-active').last().removeClass('notebook-step-contents-active');
};
var toggleGenerate = function() {
	$('#new-notebook-continue-button').toggle();
	$('#new-notebook-generate-button').toggle();
};
var toggleNextStep = function() {

}

// Proceed
$('#new-notebook-continue-button').click(function() {
	switch ($('.active-notebook-step').attr('id').split('-')[2]) {
		case 'data':
			if ($('#processed-data .selected').length === 0) {
				alert('To continue, please select a dataset.');
			} else {
				goAhead();
			}
			break; 
		case 'tools':
			if ($('.toolkit-radio:checked').length === 0) {
				alert('To continue, please select a toolkit.');
			} else {
				goAhead();
				$('#new-notebook-continue-button').hide();
				$('#new-notebook-generate-button').show();
				$('#new-notebook-generate-button').prop('disabled', false);
			}
			break;
	}
})

// Go Back
$('#new-notebook-back-button').click(function() {
	switch ($('.active-notebook-step').attr('id').split('-')[2]) {
		case 'tools':
			$('#new-notebook-back-button').toggle();
			goBack()
			break;
		case 'review':
			goBack();
			if ($('.notebook-step-contents-active').attr('id') != 'new-notebook-loading') {
				$('#new-notebook-continue-button').show();
				$('#new-notebook-generate-button').hide();
			}
			break;
	}
})

// Generate
$('#new-notebook-generate-button').click(function() {
	// Fix UI
	$('#new-notebook-review').removeClass('notebook-step-contents-active');
	$('#new-notebook-loading').addClass('notebook-step-contents-active');
	$('#new-notebook-generate-button').prop('disabled', true);
})

// Get Notebook Config
var getNotebookConfiguration = function() {
	return $('#new-notebook-selected-data .selected-object-card-title').html();
};


// Get Live URL from UID
var addNotebookLink = function(notebook_uid) {
	$('#new-notebook-results').addClass('notebook-step-contents-active');
	$('#new-notebook-loading').removeClass('notebook-step-contents-active');
	$('#new-notebook-link').attr('href', window.location.origin+'/notebook-generator-web/notebook/'+notebook_uid);
}

// Upload Notebook
var uploadNotebook = function(notebook_data) {
	$.ajax({
		url: "{{ url_for('upload_api') }}",
		type: "post",
		data: JSON.stringify(notebook_data),
		contentType: "application/json; charset=utf-8",
		dataType: "json",
		success: function(notebook_uid) {
			addNotebookLink(notebook_uid['notebook_uid']);
		}				
	})
}

// Launch Notebook
var generateNotebook = function(notebook_configuration) {
	$.ajax({
		url: "{{ url_for('generate_api') }}",
		type: "post",
		data: notebook_configuration,
		contentType: "application/json; charset=utf-8",
		dataType: "json",
		success: function(notebook_data) {
			uploadNotebook(notebook_data);
		}				
	})
};

// Listener
$('#new-notebook-generate-button').click(function() {
	notebook_configuration = getNotebookConfiguration();
	generateNotebook(notebook_configuration);
});

// Delete Notebook
var deleteNotebook = function(notebook_uid) {
	$.ajax({
		url: "{{ url_for('delete_api') }}",
		type: "post",
		data: notebook_uid,
		contentType: "application/json; charset=utf-8",
		dataType: "json",
		success: function(notebook_uid) {
			console.log('Deleted notebook '+notebook_uid['notebook_uid']+'.');
		}				
	})
};

// Delete Notebook
$('.delete-notebook-button').click(function(evt) {
	notebook_uid = $(evt.target).parents('.notebook-card').attr('id');
	deleteNotebook(notebook_uid);
	location.reload();
})


</script>

{% endblock %}