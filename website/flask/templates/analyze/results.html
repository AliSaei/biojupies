{% extends 'base.html' %}
{% import 'macros.html' as macros %}

{% block head %}<title>Notebook Generator | Results</title>{% endblock %}

{% block content %}

<div class="container">
	<div class="row">
		<div class="col-8 large mt-5 pl-4">Results</div>
		<div class="col-4 text-right mt-5">
			<button class="btn btn-primary black border-black-custom bg-white nodecoration mr-2" onclick="goBack();"><i class="fa fa-angle-left mr-2"></i>Back</button>
			<a class="btn btn-primary black border-black-custom bg-white nodecoration mr-2" href="{{url_for('analyze')}}">New Notebook</a>
		</div>
	</div>
	<div class="row">
		<hr width="100%" class="mt-3 mb-0">
		<div class="col-12 text-center pb-5" style="overflow: hidden;">

			<!-- Status and Loader -->
			<div id="status" class="mt-5 medium">Generating your Jupyter Notebook...</div>
			<div id="description" class="mt-4 very-small light">A link will be displayed below when the notebook is ready.</div>
			<div class="loader">Loading...</div>

			<!-- Notebook Link -->
			<div id="results" class="hidden">
				<!-- <hr width="50%" class="mb-4"> -->
				<div class="row mt-5">
					<div class="col-3 offset-1">
						<a id="notebook-link" href="{{ url_for('view_notebook', notebook_uid='') }}" target="_blank" data-notebook_configuration="{{ notebook_configuration }}">
							<div class="border-custom rounded px-3 py-3">
								<img src="{{ url_for('static', filename='img/notebook.png') }}" class="w-100" id="notebook-preview-image">
							</div>
						</a>
					</div>
					<div class="col-7 text-left pl-4">
						<div class="regular medium mt-2">{{ notebook_configuration_dict['notebook']['title'] }}</div>
						<div class="text-muted regular very-small mt-3">Dataset:<span class="light font-italic"> <a href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc={{ notebook_configuration_dict['data']['parameters']['gse'] }}" target="_blank">{{ notebook_configuration_dict['data']['parameters']['gse'] }}</a></span></div>
						<div class="text-muted regular very-small mt-2">Analysis Tools:<span class="light font-italic"> {{ tool_string }}</span></div>
							{% if notebook_configuration_dict['signature']|length %}
								<div class="text-muted regular very-small mt-2 light">Signature:
									<span class="light font-italic">{{ notebook_configuration_dict['signature']['A']['name'] }}</span>
									<span class="light">vs</span>
									<span class="light font-italic">{{ notebook_configuration_dict['signature']['B']['name'] }}</span>
								</div>
							{% endif %}
						<div class="row mt-3">
							<div class="col-2">
								<span id="tweet" class="d-inline-block"></span>
							</div>
							<div class="col-5">
								<div id="share-email" class="rounded micro bold d-inline-block">
									<a href="" title="Share by Email" class="white nodecoration">
										<i class="fa fa-envelope mr-2"></i>E-mail
									</a>
								</div>
								<div id="copy-link" class="rounded micro bold d-inline-block white">
									<i class="fa fa-copy mr-2"></i>Copy Link
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Reanalyze User-submitted Dataset -->
			<div id="reanalyze" class="mt-5 small light pt-3 hidden">
				<div>Use the link below to re-analyze the uploaded dataset:</div>
				<div class="mt-2 very-small"><a href="{{ url_for('add_tools', _external=True) }}?uid=" class="nodecoration" target="_blank">{{ url_for('add_tools', _external=True) }}?uid=</a></div>
			</div>
			<!-- <input id="notebook-configuration" type="hidden" value="{{ notebook_configuration }}"> -->
		</div>
	</div>
</div>

{% endblock %}

{% block footer %}

<script type="text/javascript">
	
	$.ajax({	
		url: "http://amp.pharm.mssm.edu/notebook-generator-server/api/generate",
		method: "POST",
		data: $('#notebook-link').attr('data-notebook_configuration'),
		// data: $('#notebook-configuration').val(),
		contentType: "application/json; charset=utf-8",
		dataType: 'json',
		success: function(res) {
			console.log(res);
			$('#status').html('Your Jupyter Notebook is available below:');
			$('#status').hide();
			$('#description').hide();
			$('#results').removeClass('hidden');
			var notebook_uid = res['notebook_url'].split('/')[6];
			$('#notebook-link').attr('href', $('#notebook-link').attr('href')+notebook_uid);
			$('.loader').hide();

			// Add link for uploaded data
			var dataset_uid = JSON.parse($('#notebook-link').attr('data-notebook_configuration'))['data']['parameters']['uid'];
			if (dataset_uid) {
				$('#reanalyze a').html($('#reanalyze a').html()+dataset_uid);
				$('#reanalyze a').attr('href', $('#reanalyze a').attr('href')+dataset_uid);
				$('#reanalyze').removeClass('hidden');
			}

			// Add Email Sharing
			$('#share-email a').attr('href', "mailto:?subject={{ notebook_configuration_dict['notebook']['title'] }}&body={{ notebook_configuration_dict['notebook']['title'] }} | {{ url_for('view_notebook', notebook_uid='', _external=True)}}"+notebook_uid)

			// Add Twitter Button
			$('#tweet').html(
				$('<a>', {
					'class': 'twitter-share-button',
					'data-size': 'large',
					'href': "https://twitter.com/intent/tweet?text={{ notebook_configuration_dict['notebook']['title'] }}&url={{ url_for('view_notebook', notebook_uid='', _external=True)}}"+notebook_uid+"&hashtags=jupyter,bioinformatics,omicstream&via=MaayanLab"
				})
			)

			// Activate Twitter Button
			window.twttr = (function(d, s, id) {
			  var js, fjs = d.getElementsByTagName(s)[0],
			    t = window.twttr || {};
			  if (d.getElementById(id)) return t;
			  js = d.createElement(s);
			  js.id = id;
			  js.src = "https://platform.twitter.com/widgets.js";
			  fjs.parentNode.insertBefore(js, fjs);

			  t._e = [];
			  t.ready = function(f) {
			    t._e.push(f);
			  };

			  return t;
			}(document, "script", "twitter-wjs"));

		},
		error: function(e) {
			$('#status').html('Sorry, there has been an error.');
			$('#description').hide();
			$('.loader').hide();
		}
	})

</script>

{% endblock %}
