{% extends 'base.html' %}
{% import 'macros.html' as macros %}

{% block content %}

<div class="container">
	<div class="row">
		<div class="col-8 large mt-5 pl-4">Generate Signature</div>
		<div class="col-4 text-right mt-5">
			<button class="btn btn-primary black border-black bg-white nodecoration mr-2" onclick="goBack();"><i class="fa fa-angle-left mr-2"></i>Back</button>
			<button class="btn btn-primary navigate black border-black bg-white nodecoration" form="configure-signature-form" type="submit" formaction="{{ url_for('configure_analysis') }}" formmethod="post">Continue<i class="fa fa-angle-right ml-2"></i></button>
		</div>
	</div>
	<div class="row">
		<hr width="100%">
		<div class="col-12">
			<form id="configure-signature-form">
				<div class="medium regular mb-2">Name the Groups</div>
				<div class="very-small light mb-3">First, name the two groups you wish to compare in the analysis.</div>
				<input type="text" name="group_a_label" class="mr-2 rounded border-grey px-2 py-1 light very-small" data-group="a" value="Control" maxlength="50">vs
				<input type="text" name="group_b_label" class="ml-2 rounded border-grey px-2 py-1 light very-small" data-group="b" value="Perturbation" maxlength="50">
				<input type="hidden" value="Select..." class="group-label-input" data-group="none" maxlength="50">
				<div class="medium regular mt-4 mb-2">Select the Samples</div>
				<div class="very-small light mb-3">To proceed, select at least three samples to add to the <span class="group-description-label" data-group="a">Control</span> group, and at least three samples to add to the <span class="group-description-label" data-group="b">Perturbation</span> group.</div>
				<table id="sample-table" class="stripe mb-5">
					<thead>
						<tr>
							<th>Group</th>
							{% for col in j.columns %}
								<th>{{ col.title() }}</th>
							{% endfor %}
						</tr>
					</thead>
					<tbody>
						{% for index, rowData in j.iterrows() %}
							<tr class="sample-row" data-group="none">
								<td>
									<div class="dropdown group-dropdown">
										<button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-group="none">Select...&nbsp</button>
										<div class="dropdown-menu">
											<span class="dropdown-item" data-dropdown-group="a"><i class="fa fa-square-full"></i>&nbsp<span class="nostyle" data-group="a">Control</span></span>
											<span class="dropdown-item" data-dropdown-group="b"><i class="fa fa-square-full"></i>&nbsp<span class="nostyle" data-group="b">Perturbation</span></span>
											<span class="dropdown-item" data-dropdown-group="none"><i class="fa fa-square-full"></i>&nbsp<span class="nostyle" data-group="none">None</span></span>
										</div>
										<input type="hidden" name="{{rowData['accession']}}-group" value="none">
									</div>
								</td>
								{% for col in j.columns %}
									<td>{{ rowData[col] }}</td>
								{% endfor %}
								<input type="hidden" name="{{rowData['accession']}}-group" value="none">
							</tr>
						{% endfor %}
					</tbody>
				</table>
				{% for key, values in f.lists() %}
					{% for value in values %}
						<input type="hidden" name="{{ key }}" value="{{ value }}">
					{% endfor %}
				{% endfor %}
				<input type="hidden" name="requires_signature" value="False">
			</form>
		</div>
	</div>
</div>

{% endblock %}

{% block footer %}

<script type="text/javascript">

	$(document).ready(function(){
	    $('#sample-table').DataTable({
	    	"lengthMenu": [[-1, 10, 25, 50], ["All", 10, 25, 50]],
	    	  "columnDefs": [
				{ "orderable": false, "targets": 0 },
				{ "searchable": false, "targets": 0 },
			  ]
	    });

	    // $('#sample-table_length').html('To proceed, select at least three samples to add to the <span class="group-description-label" data-group="a">Control</span> group, and at least three samples to add to the <span class="group-description-label" data-group="b">Perturbation</span> group.')

	    $('.dropdown-item').click(function(evt) {
	    	var $item = $(evt.target).hasClass('dropdown-item') ? $(evt.target) : $(evt.target).parents('.dropdown-item'),
	    		new_group = $item.data('dropdown-group'),
	    		new_label = $('.group-label-input[data-group="'+new_group+'"]').val();
    		$(evt.target).parents('.dropdown').find('button').html(new_label+'&nbsp').attr('data-group', new_group);
    		$(evt.target).parents('.dropdown').find('input').val(new_group);
    		$(evt.target).parents('tr').attr('data-group', new_group);
	    })

	    function autoSelect(group, value) {
	    	var hit = false;
	    	if (value.length > 0) {
		    	$('#sample-table tr').each(function(index, row) {
		    		if ($(row).find('td:not(:first-child)').text().toLowerCase().indexOf(value.toLowerCase()) > -1) {
		    			$(row).find('[data-dropdown-group="'+group+'"]').click();
		    			hit = true;
		    		} else {
		    			if (group == $(row).find('.dropdown-toggle').attr('data-group')) {
			    			$(row).find('[data-dropdown-group="none"]').click();
		    			}
		    		}
		    	})
	    	}
	    	return hit
	    }

	    $('.group-label-input').change(function(evt) {
	    	var value = $(evt.target).val(),
	    		group = $(evt.target).data('group');
	    	$('[data-group="'+group+'"]:not(tr)').text(value);
	    	autoSelect(group, value);
	    })

	    var hit, terms=['Control', 'Ctl', 'Untreated', 'Vehicle', 'Normal', 'Non-specific', 'DMSO'];
	    for (i = 0; i < terms.length; i++) {
	    	hit = autoSelect('a', terms[i]);
	    	if (hit) { 
	    		$('input[name="group_a_label"]').val(terms[i]);
	    		break
	    	}
	    }

	});

</script>

{% endblock %}
